# ูุณุชูุฏุงุช ุณุณุชู ุชุญูู ุฏุฑ ูุญุธู ฺฉูุฏู (Realtime Candle Delivery)

ุงู ุณูุฏ ุฎูุงุตู ูู ูพุงุฏูโุณุงุฒ ุณุณุชู ุฏุฑุงูุชุ ูพุฑุฏุงุฒุด ู ุงุฑุณุงู ุฏุฑ ูุญุธู ฺฉูุฏูโูุง ุงุฑุฒ ุฏุฌุชุงู ุจุฑุง ุณุณุชู ฺุงุฑุชูฺฏ ุงุณุช.

## ๐ ููุง ฺฉู ูุนูุงุฑ (Architecture Overview)

ุฌุฑุงู ุฏุงุฏู ุจู ุตูุฑุช ุฒุฑ ุทุฑุงุญ ุดุฏู ุงุณุช ุชุง ุนููฺฉุฑุฏ ุจุงูุง (High Performance) ู ุฌุฏุง ุณุงุฒ ูุณุฆููุชโูุง (Separation of Concerns) ุฑุนุงุช ุดูุฏ:

```mermaid
graph LR
    Binance(Binance WebSocket) -->|Stream| Worker[Kavan.Worker]
    Worker -->|Upsert| DB[(SQL Database)]
    Worker -->|Publish (Fire-and-Forget)| Redis[(Redis Pub/Sub)]
    Redis -->|Subscribe| API[Kavan.Api]
    API -->|SignalR| Client((Frontend Client))
```

## ๐ ุงุฌุฒุง ุณุณุชู (Components)

### 1. ุณุฑูุณ ุฏุฑุงูุช ู ูพุฑุฏุงุฒุด (Ingestion Layer)
**ูุญู:** `Kavan.Worker`
**ุณุฑูุณ:** `Binance1mKlineIngestionService`

ุงู ุณุฑูุณ ูุณุฆููุช ุงุชุตุงู ุจู ุจุงููุณ ู ูุฏุฑุช ุฏุงุฏูโูุง ุฑุง ุจุฑ ุนูุฏู ุฏุงุฑุฏ:
*   **ุงุชุตุงู ูพุงุฏุงุฑ:** ุงุณุชูุงุฏู ุงุฒ `BinanceKlineWebSocket` ุจุฑุง ุฏุฑุงูุช ูุญุธูโุง ุฏุงุฏูโูุง.
*   **ูุฏุฑุช ฺฏูพ (Gap Analysis):** ุจุฑุฑุณ ุฎูุฏฺฉุงุฑ ฺฉูุฏูโูุง ุฌุง ุงูุชุงุฏู ู ุฏุฑุงูุช ุขููุง ุงุฒ ุทุฑู REST API.
*   **ุฐุฎุฑู ุณุงุฒ ูุทูุฆู:** ุงุณุชูุงุฏู ุงุฒ ุฏุณุชูุฑ `MERGE` ุฏุฑ SQL ุจุฑุง Upsert ฺฉุฑุฏู ุฏุงุฏูโูุง (ุฌููฺฏุฑ ุงุฒ ุชฺฉุฑุงุฑ ู ุชุถูู ุณุฑุนุช).
*   **ุงุฑุณุงู ุบุฑููฺฏุงู:** ุงุฑุณุงู ุฏุงุฏู ุจู Redis ุจู ุตูุฑุช Fire-and-Forget ุชุง ููููโุง ุฏุฑ ุฏุฑุงูุช ุฏุงุฏูโูุง ุจุงููุณ ุงุฌุงุฏ ูุดูุฏ.

### 2. ูุงู ุงูุชุดุงุฑ ูพุงู (Broadcasting Layer)
**ูุญู:** `InfrastructureLayer`
**ุณุฑูุณ:** `RedisCandleBroadcaster`

*   ูพุงุฏูโุณุงุฒ ุงูฺฏู Pub/Sub ุจุง ุงุณุชูุงุฏู ุงุฒ Redis.
*   ฺฉุงูุงู: `candles-realtime`
*   ุงู ูุงู Worker ุฑุง ุงุฒ API ุฌุฏุง ูโฺฉูุฏ ุชุง ูุฑ ฺฉุฏุงู ุจุชูุงููุฏ ุฌุฏุงฺฏุงูู Scale ุดููุฏ.

### 3. ูุงู ูุตุฑู ู ุชุญูู (Consumption & Delivery Layer)
**ูุญู:** `Kavan.Api`
**ุณุฑูุณโูุง:** `CandleRedisConsumer` ู `CandleHub`

*   **CandleRedisConsumer:** ฺฉ `BackgroundService` ฺฉู ุจู Redis ฺฏูุด ูโุฏูุฏ. ุฏุงุฑุง ูฺฉุงูุฒู **Auto-Reconnect** ุจุฑุง ูุฏุฑุช ูุทุนโูุง ุงุญุชูุงู Redis.
*   **CandleHub:** ูุฏุฑุช ฺฉูุงูุชโูุง SignalR.
    *   **ฺฏุฑููโุจูุฏ:** ฺฉูุงูุชโูุง ุจุง ูุชุฏ `Subscribe` ุนุถู ฺฏุฑููโูุง ุฎุงุต ูโุดููุฏ (ูุซูุงู `candle:BTCUSDT:1m`) ุชุง ููุท ุฏุงุฏูโูุง ูุฑุชุจุท ุฑุง ุฏุฑุงูุช ฺฉููุฏ.
    *   **Contract:** ุงูุชุฑูุณ `ICandleClient` ุจุฑุง ุชุถูู ุณุงุฎุชุงุฑ ุฏุงุฏู ุงุฑุณุงู ุจู ฺฉูุงูุช.

## ๐ฆ ุณุงุฎุชุงุฑ ุฏุงุฏู (DTO)

ุจุฑุง ุจูููโุณุงุฒ ุชุฑุงูฺฉ ุดุจฺฉูุ ุงุฒ ฺฉ DTO ุณุจฺฉ ุงุณุชูุงุฏู ุดุฏู ุงุณุช:

```csharp
public record CandleDto(
    long OpenTime,
    long CloseTime,
    decimal Open,
    decimal High,
    decimal Low,
    decimal Close,
    decimal Volume,
    bool IsFinal
);
```

## ๐ ุฑุงูููุง ุงุฌุฑุง (How to Run)

### ูพุดโูุงุฒูุง
*   **SQL Server:** ุฏุชุงุจุณ ุงุตู.
*   **Redis:** ุจุฑุง ูพุงูโุฑุณุงู (ุงฺฏุฑ ูุตุจ ูุฏุงุฑุฏุ ูุงู `docker-compose.yml` ุฏุฑ ุฑูุช ูพุฑูฺู ููุฌูุฏ ุงุณุช).

### ุฏุณุชูุฑุงุช ุงุฌุฑุง

1.  **ุงุฌุฑุง Redis (ุฏุฑ ุตูุฑุช ูุงุฒ):**
    ```powershell
    docker compose up -d
    ```

2.  **ุงุฌุฑุง Worker (ุฏุฑุงูุช ุฏุงุฏู):**
    ```powershell
    dotnet run --project Kavan.Worker
    ```

3.  **ุงุฌุฑุง API (ุณุฑูุณ ุฏู ุจู ฺฉูุงูุช):**
    ```powershell
    dotnet run --project Kavan.Api
    ```

### ุงุชุตุงู ฺฉูุงูุช (Frontend)
*   **ุขุฏุฑุณ ูุงุจ:** `/hubs/candles`
*   **ูุชุฏ ุนุถูุช:** `Subscribe(symbol, timeframe)`
*   **ุฑูุฏุงุฏ ุฏุฑุงูุช:** `CandleUpdated`
