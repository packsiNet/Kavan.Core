## مسئله
- در خروجی چارتِ `GET /api/Signals/{id}` ممکن است کندل محرک با `IsTrigger=true` در آرایه‌ی `Candles` حذف/جایگزین شود چون بخش «قبل» همان کندل با زمان بسته‌شدن برابر را پیش‌تر اضافه می‌کند.

## راه‌حل فنی
### 1) اصلاح فیلتر کندل‌های «قبل»
- در `CandlesQueryService.GetBeforeAsync` فیلتر را از `CloseTime <= pivotCloseTime` به `CloseTime < pivotCloseTime` تغییر دهیم تا کندلِ نقطه‌ی پیوت فقط از اسنپ‌شات سیگنال وارد شود.
- فایل‌های هدف: `InfrastructureLayer/BusinessLogic/Services/Candles/CandlesQueryService.cs` در همه‌ی شاخه‌های تایم‌فریم.

### 2) اولویت به اسنپ‌شات در ادغام
- در `GetSignalByIdHandler` هنگام ادغام:
  - به‌جای صرفاً حذف تکرار با `HashSet`, از `Dictionary<long, CandleDto>` استفاده کنیم تا اگر کندلی با همان `CloseTime.Ticks` وجود داشت و نسخه‌ی اسنپ‌شات با `IsTrigger=true` آمد، نسخه‌ی قبلی جایگزین شود.
  - در پایان، اگر کندل محرک هنوز در خروجی نیست، آن را به‌صورت صریح اضافه کنیم تا تضمین وجود داشته باشد.
- فایل هدف: `ApplicationLayer/Features/Signals/Handler/GetSignalByIdHandler.cs` در ناحیه‌ی ادغام `before + snapshot + after`.

### 3) شمارش کندل‌ها
- پارامترپذیری را اضافه کنیم تا از کوئری‌استرینگ مقادیر `before` و `after` خوانده شود؛ پیش‌فرض‌ها `before=100` و `after=10`.
- برای رفع فوری، می‌توانیم فعلاً مقدار ثابت 100/10 را نگه داریم و فقط اصلاح حضور کندل محرک را اعمال کنیم.

### 4) راستی‌آزمایی
- تست با سناریوهایی که کندل «قبل» و اسنپ‌شات زمان بسته‌شدن یکسان دارند؛ انتظار می‌رود نسخه‌ی اسنپ‌شات با `IsTrigger=true` در خروجی باقی بماند.
- تست بدون کندل‌های بعد؛ خروجی باید شامل قبل + اسنپ‌شات باشد و کندل محرک در میان لیست باشد.

## خروجی مورد انتظار
- آرایه‌ی `SignalDto.Candles` همیشه شامل کندل محرک با `IsTrigger=true` است و دقیقا یکی از کندل‌های لیست همان کندل فعال‌کننده‌ی سیگنال خواهد بود.

آیا با اجرای این اصلاحات موافقید؟