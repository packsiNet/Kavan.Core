## هدف
- پیاده‌سازی نمایش چارت کندلی برای `Symbol` و `Timeframe` سیگنال و قرار دادن لیبل/مارکر دقیق روی "کندل محرک" به‌کمک فیلد جدید `IsTrigger`.
- پشتیبانی از الگوهای چندکندلی (مثل سه کلاغ سیاه) با هایلایت محدوده‌ی اسنپ‌شات و متمایزسازی کندل محرک.

## قرارداد داده‌ها
- Endpoint: `GET /api/Signals/{id}`
- خروجی شامل:
  - `SignalDto`: `Id`, `Symbol`, `Timeframe`, `SignalTime`, `SignalCategory`, `SignalName`, `Direction`, `BreakoutLevel`, `Tolerance`, ...
  - `LastCandle`: `OpenTime`, `CloseTime`, `Open`, `High`, `Low`, `Close`, `Volume`, `Index`, `IsTrigger=true`
  - `Candles`: لیست اسنپ‌شات با فیلدهای `Index`, `OpenTime`, `CloseTime`, `Open`, `High`, `Low`, `Close`, `Volume`, `IsTrigger`
- معنی `IsTrigger`:
  - روی یکی از رکوردهای `Candles` مقدار `true` است (معمولاً آخرین آیتم)، همان کندلی که سیگنال را ایجاد کرده.

## گام‌ها برای نمایش چارت
- دریافت جزئیات سیگنال:
  - با `GET /api/Signals/{id}` داده‌ها را بگیرید.
- آماده‌سازی چارت برای `symbol` و `timeframe`:
  - دیتای کندل‌های چارت را برای همان `Symbol` و `Timeframe` بارگذاری کنید.
  - مطمئن شوید محدوده‌ای شامل `LastCandle.CloseTime` در چارت موجود است؛ در صورت نبود، تاریخچه‌ی بیشتری را درخواست کنید.
- همترازسازی کندل محرک:
  - کندلی را بیابید که `candle.closeTime === SignalDto.LastCandle.CloseTime`.
  - اگر دقیقاً یافت نشد، با تولرانس زمانی برابر طول تایم‌فریم (مثلاً 60 ثانیه برای `1m`) نزدیک‌ترین کندل را انتخاب کنید.
- افزودن مارکر/لیبل محرک:
  - روی کندل محرک یک مارکر قابل‌مشاهده قرار دهید.
  - رنگ بر اساس `Direction`: `1` سبز (صعودی)، `-1` قرمز (نزولی)، `0` خاکستری (خنثی).
  - متن لیبل: ترکیب `SignalCategory` + `SignalName` + اختیاری `BreakoutLevel` (مثلاً: `EMA • PriceBelowEMA10 @ 2,430`).
- هایلایت محدوده الگوهای چندکندلی:
  - اگر `Candles.length > 1`، بازه‌ای از `Candles[0].OpenTime` تا `Candles[last].CloseTime` را با یک نوار پس‌زمینه/براکت روی چارت مشخص کنید.
  - کندل‌هایی که `IsTrigger=false` هستند را با استایل ثانویه (مثلاً border) و کندل `IsTrigger=true` را با استایل برجسته (آیکن ستاره/فلگ) نمایش دهید.

## UI/UX و گزینه‌ی جدید
- اضافه‌کردن گزینه‌ها:
  - `نمایش کندل محرک` (toggle): نمایش/عدم نمایش مارکر محرک.
  - `نمایش محدوده الگو` (toggle): نمایش/عدم نمایش ناحیه اسنپ‌شات چندکندلی.
  - `چسبندگی به کندل محرک` (toggle): اسکرول/زوم چارت در هنگام بازشدن جزئیات، به‌صورت خودکار روی کندل محرک فوکوس شود.
- رفتارها:
  - کلیک روی مارکر محرک: نمایش tooltip شامل `SignalCategory`, `SignalName`, `SignalTime`, `BreakoutLevel`, `VolumeRatio`, ...
  - همگام‌سازی با کاربر: اگر کاربر تایم‌فریم چارت را تغییر داد، هشدار/بازگشت به `SignalDto.Timeframe` یا تلاش برای نگاشت نزدیک‌ترین کندل.

## نگاشت به لایبرری چارت
- برای `lightweight-charts`:
  - سری کندل را بسازید؛ سپس با `createSeries`/`setMarkers` یک مارکر از نوع `shape: 'arrowDown'|'arrowUp'|'circle'` روی time کندل محرک اضافه کنید.
  - برای محدوده الگو، از `createPriceLine` یا overlay مستطیل با لایه‌ی جداگانه استفاده کنید.
- برای TradingView/TVL:
  - با `createShape` روی زمان کندل محرک یک shape (فلگ/فلش) قرار دهید.
  - برای ناحیه، از `drawRect` روی بازه‌ی زمانی اسنپ‌شات استفاده کنید.

## شبه‌کد
- دریافت:
  - `const s = await api.get('/api/Signals/{id}')`
- یافتن کندل محرک در داده‌ی چارت:
  - `const anchor = s.LastCandle.CloseTime`
  - `const targetBar = bars.find(b => b.time === toUnix(anchor)) || nearestByTolerance(bars, anchor, timeframe)`
- مارکر:
  - `addMarker({ time: targetBar.time, position: s.Direction>0?'aboveBar':'belowBar', color: dirColor(s.Direction), text: s.SignalCategory+' • '+s.SignalName })`
- محدوده الگو:
  - اگر `s.Candles.length>1`:
    - `const start = s.Candles[0].OpenTime`
    - `const end = s.Candles[s.Candles.length-1].CloseTime`
    - `drawRangeOverlay(start, end)`
  - کندل محرک:
    - `const trigger = s.Candles.find(c=>c.IsTrigger)`
    - `highlightBar(trigger.CloseTime)`

## سناریوهای لبه و خطا
- عدم تطابق زمان‌ها: اگر کندل محرک یافت نشد، با تولرانس یک گام تایم‌فریم نزدیک‌ترین کندل انتخاب شود و در لاگ UI ثبت گردد.
- داده ناکافی: اگر چارت داده‌ی کافی ندارد، درخواست بارگذاری تاریخچه‌ی بیشتر.
- mismatch `Symbol`/`Timeframe`: اگر چارت در وضعیت دیگری است، پیام راهنما برای تنظیم به `SignalDto.Symbol/Timeframe`.

## معیارهای پذیرش
- برای هر سیگنال، مارکر کندل محرک روی چارت دقیقاً روی کندل متناظر نمایش داده می‌شود.
- برای الگوهای چندکندلی، محدوده الگو هایلایت و کندل محرک متمایز می‌شود.
- گزینه‌های UI به‌درستی عمل کرده و هیچ لگ قابل‌توجهی در رندر ایجاد نمی‌کنند.
- در نبود اسنپ‌شات یا عدم‌تطابق زمان، سیستم رفتار جایگزین با تولرانس دارد و کاربر را مطلع می‌کند.

## نکات اجرایی
- زمان‌ها را به یونیکس (ثانیه/میلی‌ثانیه مطابق لایبرری) تبدیل کنید.
- رنگ‌ها: سبز `#22c55e`، قرمز `#ef4444`، خنثی `#9CA3AF`.
- مارکرها را در لایه‌ی جداگانه نگه دارید تا تحت زوم/اسکرول ثابت بمانند.
- کش سبک برای جزئیات سیگنال جهت سوئیچ سریع بین چارت‌ها بدون درخواست‌های اضافی.