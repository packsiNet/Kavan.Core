name: CI-CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  APP_URL: ${{ secrets.APP_URL }}
  API_PROJECT_PATH: Kavan.Api/Kavan.Api.csproj
  WORKER_PROJECT_PATH: Kavan.Worker/Kavan.Worker.csproj
  API_PUBLISH_DIR: api-app
  WORKER_PUBLISH_DIR: worker-app
  API_DEPLOY_PATH: /var/www
  WORKER_DEPLOY_PATH: /var/www

jobs:
  build_test_publish_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore Kavan.Core.sln

      - name: Build
        run: dotnet build Kavan.Core.sln --configuration Release --no-restore

      - name: Test
        run: dotnet test Tests/Kavan.Tests/Kavan.Tests.csproj --configuration Release --no-build

      - name: Publish API
        run: dotnet publish ${{ env.API_PROJECT_PATH }} --configuration Release --output ${{ env.API_PUBLISH_DIR }}

      - name: Publish Worker
        run: dotnet publish ${{ env.WORKER_PROJECT_PATH }} --configuration Release --output ${{ env.WORKER_PUBLISH_DIR }}

      # حذف wwwroot از پکیج API (اختیاری)
      - name: Strip wwwroot from API publish package
        run: |
          if [ -d "${{ env.API_PUBLISH_DIR }}/wwwroot" ]; then
            rm -rf "${{ env.API_PUBLISH_DIR }}/wwwroot"
          fi

      - name: Prepare remote directories
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # ایجاد مسیر پروژه API در سرور
            mkdir -p ${{ env.API_DEPLOY_PATH }}
            
            # ایجاد مسیر پروژه Worker در سرور
            mkdir -p ${{ env.WORKER_DEPLOY_PATH }}

            # ایجاد مسیرهای permanent uploads
            mkdir -p /var/www/kavan-uploads/ideas
            mkdir -p /var/www/kavan-uploads/profiles

            chmod -R 755 /var/www/kavan-uploads

            echo "APP_URL=${APP_URL}" > ${{ env.API_DEPLOY_PATH }}/deploy.env

      - name: Deploy API files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: ${{ env.API_PUBLISH_DIR }}/*
          target: ${{ env.API_DEPLOY_PATH }}
          overwrite: true

      - name: Deploy Worker files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: ${{ env.WORKER_PUBLISH_DIR }}/*
          target: ${{ env.WORKER_DEPLOY_PATH }}
          overwrite: true

      - name: Configure Persistent Uploads (API)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            mkdir -p ${{ env.API_DEPLOY_PATH }}/wwwroot

            # اگر uploads وجود دارد و symlink نبود → به persistent منتقل کن
            if [ -d "${{ env.API_DEPLOY_PATH }}/wwwroot/uploads" ] && [ ! -L "${{ env.API_DEPLOY_PATH }}/wwwroot/uploads" ]; then
                cp -rn ${{ env.API_DEPLOY_PATH }}/wwwroot/uploads/* /var/www/kavan-uploads/ || true
                rm -rf ${{ env.API_DEPLOY_PATH }}/wwwroot/uploads
            fi

            # ساخت Symlink امن
            ln -sfn /var/www/kavan-uploads ${{ env.API_DEPLOY_PATH }}/wwwroot/uploads

      - name: Reload and Restart Services
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            sudo systemctl daemon-reload
            sudo systemctl restart api-packsi
            # فرض بر این است که سرویس ورکر با نام kavan-worker ساخته شده است
            sudo systemctl restart kavan-worker
