name: CI-CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  APP_URL: ${{ secrets.APP_URL }}
  PROJECT_PATH: Kavan.Api/Kavan.Api.csproj
  PUBLISH_DIR: build/publish
  DEPLOY_PATH: /var/www/api-app

jobs:
  build_test_publish_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Restore
        run: dotnet restore Kavan.Core.sln
      - name: Build
        run: dotnet build Kavan.Core.sln --configuration Release --no-restore
      - name: Test
        run: dotnet test Tests/Kavan.Tests/Kavan.Tests.csproj --configuration Release --no-build
      - name: Publish
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output ${{ env.PUBLISH_DIR }}
      - name: Strip wwwroot from publish package
        run: |
          set -e
          if [ -d "${{ env.PUBLISH_DIR }}/wwwroot" ]; then
            rm -rf "${{ env.PUBLISH_DIR }}/wwwroot"
          fi
      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            mkdir -p ${{ env.DEPLOY_PATH }}
            find ${{ env.DEPLOY_PATH }} -mindepth 1 -maxdepth 1 ! -name 'wwwroot' -exec rm -rf {} +
            echo "APP_URL=${APP_URL}" > ${{ env.DEPLOY_PATH }}/deploy.env
      - name: Deploy files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: ${{ env.PUBLISH_DIR }}/*
          target: ${{ env.DEPLOY_PATH }}
          overwrite: true
