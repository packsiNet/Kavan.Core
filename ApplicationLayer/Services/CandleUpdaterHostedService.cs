using ApplicationLayer.Interfaces.Binance;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace ApplicationLayer.Services;

public class CandleUpdaterHostedService(
    IServiceScopeFactory _scopeFactory,
    ILogger<CandleUpdaterHostedService> _logger
) : BackgroundService
{
    private DateTime _last5mUpdate = DateTime.MinValue;
    private DateTime _last1hUpdate = DateTime.MinValue;
    private DateTime _last4hUpdate = DateTime.MinValue;
    private DateTime _last1dUpdate = DateTime.MinValue;
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("üöÄ CandleUpdaterHostedService started.");

        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                // ‚úÖ Scope ÿ¨ÿØ€åÿØ ÿ®ÿ±ÿß€å Ÿáÿ± iteration
                using var scope = _scopeFactory.CreateScope();

                var symbolSyncService = scope.ServiceProvider.GetRequiredService<IBinanceSymbolSyncService>();
                var candleUpdater = scope.ServiceProvider.GetRequiredService<ICandleUpdaterService>();
                var candleAggregator = scope.ServiceProvider.GetRequiredService<ICandleAggregatorService>();

                var symbols = await symbolSyncService.GetActiveSymbolsAsync();
                _logger.LogInformation("üîç Found {Count} active symbols to update.", symbols.Count);

                // --- ŸÖÿ±ÿ≠ŸÑŸá 1: ÿØÿ±€åÿßŸÅÿ™ ⁄©ŸÜÿØŸÑ‚ÄåŸáÿß€å 1 ÿØŸÇ€åŸÇŸá‚Äåÿß€å
                foreach (var symbol in symbols)
                {
                    _logger.LogInformation("‚è± Updating {Symbol} (1m)...", symbol);
                    await candleUpdater.UpdateCandlesAsync(symbol, "1m", stoppingToken);
                }

                // --- ŸÖÿ±ÿ≠ŸÑŸá 2: ÿ≥ÿßÿÆÿ™ ÿ™ÿß€åŸÖ‚ÄåŸÅÿ±€åŸÖ‚ÄåŸáÿß€å ÿ®ÿßŸÑÿßÿ™ÿ± ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿ≤ŸÖÿßŸÜ
                var now = DateTime.UtcNow;

                if ((now - _last5mUpdate).TotalMinutes >= 5)
                {
                    _logger.LogInformation("‚è± Aggregating 5m candles...");
                    await candleAggregator.AggregateCandlesAsync("5m");
                    _last5mUpdate = now;
                }

                if ((now - _last1hUpdate).TotalHours >= 1)
                {
                    _logger.LogInformation("‚è± Aggregating 1h candles...");
                    await candleAggregator.AggregateCandlesAsync("1h");
                    _last1hUpdate = now;
                }

                if ((now - _last4hUpdate).TotalHours >= 4)
                {
                    _logger.LogInformation("‚è± Aggregating 4h candles...");
                    await candleAggregator.AggregateCandlesAsync("4h");
                    _last4hUpdate = now;
                }

                if ((now - _last1dUpdate).TotalDays >= 1)
                {
                    _logger.LogInformation("‚è± Aggregating 1d candles...");
                    await candleAggregator.AggregateCandlesAsync("1d");
                    _last1dUpdate = now;
                }

                _logger.LogInformation("‚úÖ Candle update and aggregation completed.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå Error in CandleUpdaterHostedService loop.");
            }
            finally
            {
                try
                {
                    await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
                }
                catch (OperationCanceledException)
                {
                    _logger.LogInformation("CandleUpdaterHostedService stopping...");
                }
            }
        }
    }
}